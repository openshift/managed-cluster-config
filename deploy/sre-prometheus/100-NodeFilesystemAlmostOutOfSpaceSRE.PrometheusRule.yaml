apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: sre-nodefilesystemalmostoutofspace-alert
    role: alert-rules
  name: sre-nodefilesystemalmostoutofspace-alert
  namespace: openshift-monitoring
spec:
  groups:
    # JIRA: https://issues.redhat.com/browse/OSD-14857
    # Fix: https://github.com/openshift/cluster-monitoring-operator/blob/release-4.13/assets/node-exporter/prometheus-rule.yaml#L68-L82
    # Note: Temporary custom SRE alert to handle the misconfigured alert. Once backports and new release in place with fix, can remove this alert.
    - name: sre-nodefilesystemalmostoutofspace-alert
      rules:
        - alert: NodeFilesystemAlmostOutOfSpaceSRE
          expr: |
            (
              node_filesystem_avail_bytes{job="node-exporter",fstype!="",mountpoint!~"/var/lib/ibmc-s3fs.*"} / node_filesystem_size_bytes{job="node-exporter",fstype!="",mountpoint!~"/var/lib/ibmc-s3fs.*"} * 100 < 3
            and
              node_filesystem_readonly{job="node-exporter",fstype!="",mountpoint!~"/var/lib/ibmc-s3fs.*"} == 0
            )
          for: 30m
          labels:
            severity: critical
            namespace: openshift-monitoring
          annotations:
            description: Filesystem on {{ $labels.device }} at {{ $labels.instance }} 
              has only {{ printf "%.2f" $value }}% available space left.
            runbook_url: https://github.com/openshift/runbooks/blob/master/alerts/cluster-monitoring-operator/NodeFilesystemAlmostOutOfSpace.md
            summary: Filesystem has less than 3% space left.
